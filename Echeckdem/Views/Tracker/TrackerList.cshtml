@model List<Echeckdem.CustomFolder.TrackerFullViewModel>

@{
    ViewData["Title"] = "Tracker List";
    ViewData["Heading"] = "Tracker List";
    ViewData["Heading_child"] = "...";
}
<style>
    .saveButton {
        padding: 5px;
        font-size: 12px;
        font-weight: bold;
        background-color: white;
        color: #dd3432;
        border: 2px solid #dd3432;
        border-radius: .375rem;
        cursor: pointer;
        width: 70px;
        height: 30px;
    }

        .saveButton:hover {
            background-color: #dd3432;
            color: white;
        }

    .ItemContainer{
        position:absolute;
        width:98vw;
        background: #ffffff;
        left: 7px;
        margin-top:45px;
        padding:15px;
        border-radius:.375rem;
    }
</style>

<div class="table-container-detailsView" id="table-container-detailsView">
    <table class="styled-table">
    <thead>
        <tr>
            <th>Organisation</th>
            <th>Site Name</th>
            <th>Inspection Notice</th>
            <th>Title</th>
            <th>Detail of Issue</th>
            <th>Status</th>
            <th>Start Date</th>
            <th>Close Date</th>
            <th>SLA</th>
            <th>Details</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var action in Model)
        {
            <tr>
                <td>@action.Oname</td>
                <td>@action.Lname</td>
                <td>@action.SelectedTPP</td>
                <td>@action.SelectedACTITLE</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>@action.SelectedSBTP</td>
                @* <td>
                        <button class="saveButton" onclick="openDetails('@action.Acid', '@action.Actid')">Details</button>
                </td> *@
                <td>
                   <a class="saveButton" href="@Url.Action("DetailsTracker", "Tracker", new { acid = action.Acid, actid = action.Actid })">Details</a>
                </td>

            </tr>
        }
    </tbody>
</table>
</div>
<div class="ItemContainer" id="addItemContainer" style="display:none;">

</div>

@section Scripts {
    <script>
        function openDetails(acid, actid) {
            $('#AcidNcAction, #AcidNcActTaken').val(acid);

            $('#editSection').show();

            $.get('@Url.Action("EditNcAction", "Tracker")', { acid }, function (ncActionData) {
                $('#Title').val(ncActionData.title);
                $('#ExternalStatus').val(ncActionData.externalStatus);
                $('#VisibleToClient').val(ncActionData.visibleToClient);
                $('#InternalStatus').val(ncActionData.internalStatus);
                $('#DetailOfIssue').val(ncActionData.detailOfIssue);
                $('#StartDate').val(ncActionData.startDate?.substring(0, 10));
                $('#DocsReceiptDate').val(ncActionData.docsReceiptDate?.substring(0, 10));
                $('#CloseDate').val(ncActionData.closeDate?.substring(0, 10));
                $('#Remarks').val(ncActionData.remarks);

                $.get('@Url.Action("EditNcActTaken", "Tracker")', { acid }, function (ncActTakenData) {
                    if (ncActTakenData && Object.keys(ncActTakenData).length > 0) {
                        $('#Actid').val(ncActTakenData.actid);
                        $('#Acdate').val(ncActTakenData.acdate?.substring(0, 10));
                        $('#Actaken').val(ncActTakenData.actaken);
                        $('#Nacdate').val(ncActTakenData.nacdate?.substring(0, 10));
                        $('#Showclient').val(ncActTakenData.showclient);
                        $('#Uno').val(ncActTakenData.Uno);
                    } else {
                        $('#ncactionTakenForm')[0].reset();
                        $('#Actid').val('');
                    }
                }).fail(() => alert("Error fetching NCACTAKEN data."));
            }).fail(() => alert("Error fetching NCACTION data."));
        }

        function cancelEdit() {
            $('#editSection').hide();
            $('#ncactionForm')[0].reset();
            $('#ncactionTakenForm')[0].reset();
        }

        function onAddNewItemClick() {
            document.getElementById("table-container-detailsView").style.display = "none";
            document.getElementById("addItemContainer").style.display = "block";

            showAddForm();
        }

        //Start of Add Form------------------------------
        function showAddForm() {

            fetch('/Tracker/Index')
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.text();
                })
                .then(html => {
                    document.getElementById("addItemContainer").innerHTML = html;

                })
                .catch(error => {
                    console.error("Error loading the form:", error);
                    document.getElementById("addItemContainer").innerHTML = "<p>Error loading the form. Please try again.</p>";
                });
        }
        //End of Add Form------------------------------
    </script>
}
