@model Echeckdem.CustomFolder.ProjectBocw.ProjectBocwViewModel

@{
    ViewData["Title"] = "Project Detail";
    ViewData["Heading"] = "Project Detail";
}

<div class="table-heading-container">
    <!-- Search bar -->
    <input type="text" id="searchBar" placeholder="Search..." class="table-search-input" onkeyup="searchTable()">

    <!-- Outer-Filter button -->
    <div class="table-filter-buttons">
        <select id="clientDropdown" onchange="populateSites()">
            <option value="">Select a Client</option>
            @foreach (var client in Model.Clients)
            {
                <option value="@client">@client</option>
            }
        </select>
        <select id="siteDropdown">
            <option value="">Select a Site</option>
        </select>
    </div>
</div>

<div class="table-container-detailsView">
    <table class="styled-table">
        <thead>
            <tr><th colspan="11" class="table-header">Select a Client and Project</th></tr>
        </thead>
        <thead>
            <tr>
                <th>Site Name:</th>
                <td data-id="SiteName"></td>
                <th>State:</th>
                <td data-id="State"></td>
                <th>City:</th>
                <td data-id="City"></td>
                <th>Project Client</th>
                <td data-id="ClientName"></td>
                <th colspan="2">Project General Contractor</th>
                <td data-id="GeneralContractor"></td>
            </tr>
            <tr>
                <th colspan="2">Construction Start Date:</th>
                <td data-id="ProjectStartDate"></td>
                <th>Construction End Date:</th>
                <td data-id="ProjectEndDate"></td>
                <th>Project Area:</th>
                <td data-id="ProjectArea"></td>
                <th>Project Cost:</th>
                <td data-id="ProjectCost"></td>
                <th>Project Manager</th>
                <td data-id="ProjectLead"></td>
            </tr>
        </thead>
    </table>

    <table class="styled-table">
        <thead>
            <tr><th class="text-center" colspan="11" class="table-header">BOCW Services</th></tr>
            <tr>
                <th>S.No.</th>
                <th>Service Type</th>
                <th>Service</th>
                <th>Category</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Completion Date</th>
                <th colspan="2">File</th>
                <th>Edit</th>
            </tr>
        </thead>
        <tbody id="complianceActivities"></tbody>
   @*  </table>
</div> *@
        <thead style="top:75px;">

            <tr><th class="text-center" colspan="11" class="table-header">On-Going Activites</th></tr>

            <tr>

                <th>Tracker For</th>
                <th>Inspection Notice</th>
                <th>Title</th>
                <th>Detail of Issue</th>
                <th>Status</th>
                <th>Start Date</th>
                <th>Close Date</th>
                <th>Details</th>

            </tr>

        </thead>
        <tbody>
            @if (Model.TrackerActions != null && Model.TrackerActions.Any())
            {
                foreach (var tracker in Model.TrackerActions)
                {
                    <tr>
                        <td>@tracker.SelectedACTP</td>
                        <td>@tracker.SelectedTPP</td>
                        <td>@tracker.SelectedACTITLE</td>
                        <td>@tracker.DetailOfIssue</td>
                        <td>@tracker.InternalStatus</td>
                        <td>@(tracker.StartDate.HasValue ? tracker.StartDate.Value.ToString("dd-MMM-yyyy") : "")</td>
                        <td>@(tracker.CloseDate.HasValue ? tracker.CloseDate.Value.ToString("dd-MMM-yyyy") : "")</td>
                        <td><a href="/DetailsView/ViewAction?acid=@tracker.Acid">Details</a></td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="8" class="text-center">No ongoing activities found.</td></tr>
            }
        </tbody>

    </table>

</div>

@section Scripts {
    <script>
        const clientSiteMap = @Html.Raw(Json.Serialize(Model.ClientSiteMap));

        function populateSites() {
            const client = document.getElementById('clientDropdown').value;
            const siteDropdown = document.getElementById('siteDropdown');
            siteDropdown.innerHTML = '<option value="">Select a Site</option>';

            if (clientSiteMap[client]) {
                clientSiteMap[client].forEach(site => {
                    siteDropdown.innerHTML += `<option value="${site}">${site}</option>`;
                });
            }
        }

        document.getElementById('siteDropdown').addEventListener('change', function () {
            const client = document.getElementById('clientDropdown').value;
            const site = this.value;

            if (client && site) {
                fetch(`/Project/GetProjectDetails?client=${encodeURIComponent(client)}&site=${encodeURIComponent(site)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data) return;

                        // Populate static project details
                        document.querySelector('td[data-id="SiteName"]').innerText = data.siteName || '';
                        document.querySelector('td[data-id="State"]').innerText = data.state || '';
                        document.querySelector('td[data-id="City"]').innerText = data.city || '';
                        document.querySelector('td[data-id="ClientName"]').innerText = data.clientName || '';
                        document.querySelector('td[data-id="GeneralContractor"]').innerText = data.generalContractor || '';
                        document.querySelector('td[data-id="ProjectStartDate"]').innerText = data.projectStartDate || '';
                        document.querySelector('td[data-id="ProjectEndDate"]').innerText = data.projectEndDate || '';
                        document.querySelector('td[data-id="ProjectArea"]').innerText = data.projectArea || '';
                        document.querySelector('td[data-id="ProjectCost"]').innerText = data.projectCost || '';
                        document.querySelector('td[data-id="ProjectLead"]').innerText = data.projectLead || '';

                        // Populate BOCW services
                        const tbody = document.getElementById('complianceActivities');
                        tbody.innerHTML = '';
                        if (data.bocwServices && data.bocwServices.length > 0) {
                            data.bocwServices.forEach((item, index) => {
                                const row = `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>BOCW</td>
                                                <td>${item.service}</td>
                                                <td>${item.category}</td>
                                                <td>${item.dueDate || ''}</td>
                                                <td>${item.status}</td>
                                                <td>${item.completionDate || ''}</td>
                                                <td colspan="2">${item.file ? `<a href="/uploads/${item.file}" target="_blank">${item.file}</a>` : 'N/A'}</td>
                                                        <td><a href="/DetailsView/EditBocw?transactionID=${item.transactionID}&lcode=${item.lcode}" class="edit-btn">   <i class="fas fa-pen edit-icon" style="color: #dd3432; font-size: 14px; cursor: pointer;"></i>>Edit</a></td>

                                                
                                            </tr>`;
                                tbody.innerHTML += row;
                            });
                        }
                    })
                    .catch(err => console.error('Error fetching project details:', err));
            }
        });
    </script>
}
